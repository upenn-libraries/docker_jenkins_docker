version: 2.1

orbs:
  docker-publish: circleci/docker-publish@0.1.7
  slack: circleci/slack@3.4.2

docker-publish: &docker-publish
  docker-publish/publish:
    context: quay.io
    registry: quay.io
    image: upennlibraries/jenkins_docker_client
    tag: lts
    post-steps:
      - run:
          name: Set Environment Variables for Slack Notification
          command: |
            echo "export GIT_COMMIT_DESC='$(git --git-dir $HOME/project/.git log --format=%B -n 1 $CIRCLE_SHA1)'" >> $BASH_ENV
            echo "export GIT_URL=<< pipeline.project.git_url >>/compare/<< pipeline.git.base_revision >>..<< pipeline.git.revision >>" >> $BASH_ENV
            source $BASH_ENV
      - slack/status:
          channel: tools-notifications
          failure_message: ":red_circle: Failure! ${CIRCLE_USERNAME}'s workflow (<${CIRCLE_BUILD_URL}|${CIRCLE_JOB}>) in <${GIT_URL}|${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BRANCH}>, Message: ${GIT_COMMIT_DESC}"
          success_message: ":tada: Success! ${CIRCLE_USERNAME}'s workflow (<${CIRCLE_BUILD_URL}|${CIRCLE_JOB}>) in <${GIT_URL}|${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BRANCH}>, Message: ${GIT_COMMIT_DESC}"
          webhook: ${SLACK_WEBHOOK}

workflows:
  build:
    jobs:
      - *docker-publish
  nightly_build:
    triggers:
      - schedule:
          cron: "0 4 * * 0"
          filters:
            branches:
              only:
                - master
    jobs:
      - *docker-publish
